---
title: Clase 11 - Caldera Framework & Procmon/Sysmon (Parte 2)
date: 2024-11-28 00:20:00 -05:00
categories: [elasticsearch , cibersecurity, kill chain, pentesting]
tags: [elasticsearch, kali, metasploit]  # TAG names should always be lowercase
---

## Descarga e Instalación de Go en Kali Linux

*Paso 1: Descargar el Instalador para Linux*
Primero, necesitas descargar el instalador de Go. Abre una terminal y navega al directorio de Downloads:*

````bash
┌──(user㉿kali)-[~/Caldera] 
└─$ cd ~/Downloads
````

Luego, descarga el archivo tarball de Go usando wget:

````bash
┌──(user㉿kali)-[~/Downloads] 
└─$ wget https://go.dev/dl/go1.23.3.linux-amd64.tar.gz
````

*Paso 2: Eliminar Cualquier Instalación Anterior de Go y Descomprimir el Archivo*

Antes de instalar la nueva versión, elimina cualquier instalación anterior de Go y descomprime el archivo descargado en /usr/local:

````bash
┌──(user㉿kali)-[~/Downloads] 
└─$ sudo rm -rf /usr/local/go && sudo tar -C /usr/local -xzf
````

*Paso 3: Añadir /usr/local/go/bin a la Variable de Entorno PATH*
Para que el sistema reconozca el comando go, necesitas añadir /usr/local/go/bin a tu variable de entorno PATH. Edita el archivo /etc/profile usando nano:*

````bash
(caldera-env)─(user㉿kali)-[~/Downloads] 
└─$ sudo nano /etc/profile
````
Añade la siguiente línea al final del archivo:

````bash
export PATH=$PATH:/usr/local/go/bin
````
Guarda los cambios y cierra nano. Luego, aplica los cambios:

````bash
(caldera-env)─(user㉿kali)-[~/Downloads] 
└─$ sudo nano /etc/profile
````
Verificar la Instalación
Finalmente, verifica la instalación ejecutando el siguiente comando:

````bash
┌──(user㉿kali)-[~] 
└─$ go version
````
![f8](/assets/imagen/f8.png)

## Comprobar nuevamente la version de Go
````bash
┌──(user㉿kali)-[~/Downloads]
└─$ go version
go version go1.23.3 linux/amd64
````

## Instalar NodeJs
A continuación, instala Node.js, una plataforma popular para construir aplicaciones de red escalables:

````bash
┌──(user㉿kali)-[~/Downloads]
└─$ sudo apt install nodejs
````
Después de la instalación, verifica la versión de Node.jspara asegurarte de que se ha instalado correctamente:

````bash
└─$ node -v
````
La salida como respuesta:
````bash
v20.17.0
````
## Instalar Npm
Npm (Node Package Manager) se utiliza para gestionar los paquetes de Node.js.Instálalo usando el siguiente comando:

````bash
┌──(user㉿kali)-[~/Downloads] 
└─$ sudo apt install npm
````
Después de la instalación, verifica la versión de npm para asegurarte de que se ha instalado correctamente:

````bash
└─$ npm -v
````
La salida debería mostrar la versión instalada de npm, por ejemplo:

````bash
6.14.4
````
### Instalando Sysmon y Procmon en VM Windows 10 / Metasploitable
Para instalar Sysmon de Sysinternals en una máquina Windows, sigue estos pasos:

1.Abrir el navegador Chrome y buscar "Sysinternals Suite" en la web de Microsoft.

2.Descargar la Suite Sysinternals, que incluye Sysmon junto con otras herramientas útiles.

3.Extraer el archivo descargado y navegar hasta la carpeta donde se encuentra el instalador de Sysmon.

4.Ejecutar el instalador con permisos de administrador y seguir las instrucciones en pantalla para completar la instalación.

Una vez instalado, Sysmon comenzará a monitorear y registrar la actividad del sistema en el registro de eventos de Windows. Puedes verificar su funcionamiento ejecutando el siguiente comando en una terminal de PowerShell:

![f83](/assets/imagen/f83.png)

````bash
PS C:\Windows\system32> cd C:\Users\user\Downloads\Sysmon
PS C:\Users\user\Downloads\Sysmon> .\Sysmon -i
````
## Así se ve la instalación de Sysmon

![f845](/assets/imagen/f845.png)

El servicio registra eventos inmediatamente y el controlador se instala como un controlador de inicio de arranque para capturar la actividad desde el comienzo del arranque que el servicio escribirá en el registro de eventos cuando se inicie.

En Vista y versiones posteriores, los eventos se almacenan en Applications and Services Logs/Microsoft/Windows/Sysmon/Operational. En sistemas más antiguos, los eventos se escriben en el Systemregistro de eventos.

Si necesita más información sobre los archivos de configuración, utilice el -? config comando.

Especifique -accepteulaque desee aceptar automáticamente el EULA durante la instalación; de lo contrario, se le solicitará interactivamente que lo acepte.

Ni la instalación ni la desinstalación requieren reiniciar.

*Vamos a Event Viewer (Local) > Applications and Services > Microsoft > Sysmon y podremos ver los eventos que Sysmon ya está capturando*

![f85](/assets/imagen/f85.png)

### Instalando Procmon
Para instalar Process Monitor (Procmon) de Sysinternals en una máquina con Windows, puedes seguir los siguientes pasos detallados:

Pasos para la Instalación de Procmon
1.Abrir el Navegador (Chrome, Edge, etc.) : Abre tu navegador web favorito.

2.Buscar Sysinternals Process Monitor: En el navegador, busca "Sysinternals Process Monitor" o visita directamente la página de Sysinternals Process Monitor en el sitio web de Microsoft.

3.Descargar Process Monitor:  El archivo comprimido de Process Monitor. El archivo suele estar en formato ZIP.

4.Extraer el Archivo ZIP: Navega a la carpeta de descargas y extrae el contenido del archivo ZIP. Deberías ver el archivo ejecutable de Process Monitor (Procmon.exe).

5.Ejecutar Process Monitor: Ejecutar la aplicación Procmon.exe. Puedes necesitar derechos de administrador para ejecutar la herramienta.

6.Aceptar los Términos de Uso*: La primera vez que ejecutes Process Monitor, se te pedirá que aceptes los términos de uso. Haz clic en "Aceptar".

## Verificar la Instalación
Una vez que Process Monitor esté en funcionamiento, verás su interfaz principal mostrando la actividad del sistema de archivos, del registro y de los procesos en tiempo real. Puedes configurar filtros para limitar la visualización a eventos específicos de interés.

## Uso Básico
*Filtrar Eventos:  Usa la opción de filtros (Filter) para ver solo los eventos que te interesan, por ejemplo, procesos específicos, eventos de registro, etc.*

*Guardar Resultados:* Puedes guardar los resultados de tus monitoreos en un archivo para análisis posterior (File -> Save).*

## Notas Adicionales
*Documentación:Para obtener más información sobre cómo utilizar Process Monitor y sus funciones avanzadas, revisa la documentación oficial.*

![f86](/assets/imagen/f86.png)

![f87](/assets/imagen/f87.png)










Eventos en un Sistema
Cuando ocurre un evento en un sistema, puede involucrar:

Network (Tránsito de Paquetes): Información que se mueve a través de la red, como paquetes de datos.

FileSystem: Actividades relacionadas con el sistema de archivos, como accesos, modificaciones y creaciones de archivos.

Métrica: Datos de rendimiento y uso de recursos del sistema.

Base de Datos: Transacciones y consultas realizadas en una base de datos.

Big Data Base: Almacenamiento de grandes volúmenes de datos recolectados de varias fuentes.

## Machine Learning (ML) en IDS
Los algoritmos de Machine Learning pueden ser utilizados para mejorar los sistemas de detección de intrusiones mediante el análisis y clasificación de datos de eventos.

Data Desbalanceada (Unbalanced Data): Cuando las clases (etiquetas) no están distribuidas de manera equitativa, dificultando la distinción entre diferentes tipos de eventos.

Data Balanceada (Balanced Data): Las clases están distribuidas equitativamente, facilitando que los modelos de ML aprendan a distinguir entre eventos benignos y maliciosos.

![fq](/assets/imagen/fq.png)

## KALI LINUX y Ataques
Kali Linux es una distribución de Linux especializada en pruebas de penetración y seguridad informática. Puede ser utilizada para realizar ataques controlados a un sistema supervisado, ayudando a identificar vulnerabilidades y mejorar la seguridad del sistema.

Elastic Defender (Antes Elastic End-point Security)
Elastic Defender es una solución de seguridad que proporciona protección contra amenazas en tiempo real. Anteriormente conocido como Elastic End-point Security, utiliza datos recolectados y análisis avanzados para detectar y responder a amenazas en el sistema.

Estos componentes juntos forman una arquitectura robusta para la detección y respuesta ante intrusiones, utilizando herramientas avanzadas y técnicas de análisis para mantener la seguridad del sistema.

## Diagrama de Evento: 

![f9](/assets/imagen/f9.png)

## Descripción del Diagrama:
Kali Linux: La herramienta desde la cual se realizan pruebas y ataques de seguridad al sistema supervisado.

*Sistema Supervisado: El sistema que está siendo monitoreado y protegido.*

*Agente: Software que recolecta datos y los envía al Big Data Base.*

*Big Data Base: Almacena grandes volúmenes de datos recolectados por los agentes.*

*Base de Datos: Donde se almacena la información procesada y utilizada para análisis.*


## Machine Learning en Sistemas de Detección de Intrusiones
Data Desbalanceada (Unbalanced Data)
Cuando los datos están desbalanceados, las clases (benignas y malignas) no están representadas de manera equitativa. Esto puede causar que el modelo de Machine Learning tenga dificultades para distinguir entre las diferentes clases, lo que puede llevar a resultados menos precisos. Por ejemplo, si un dataset tiene muchas más instancias de tráfico benigno que de tráfico malicioso, el modelo puede aprender a clasificar casi todo como benigno, ignorando los casos de tráfico malicioso.

## Data Balanceada (Balanced Data)
En un dataset balanceado, las clases están representadas de manera más equitativa, lo que permite que el modelo de Machine Learning aprenda a distinguir correctamente entre eventos benignos y maliciosos. Usando etiquetas, el modelo puede aprender patrones específicos y mejorar la precisión en la detección de intrusiones.

## Kali Linux y Elastic Defender
Kali Linux es una herramienta poderosa que se utiliza para realizar pruebas de penetración y ataques controlados al sistema supervisado. Estas pruebas ayudan a identificar vulnerabilidades y fortalecer las defensas del sistema.

Elastic Defender (anteriormente conocido como Elastic End-point Security) es una solución de seguridad que ofrece protección en tiempo real contra amenazas. Utiliza datos recolectados y análisis avanzados para detectar y responder a actividades sospechosas en el sistema.

## INSTALACIÓN DE CALDERA EN KALI LINUX

## Paso 1: Crear un entorno virtual
Primero, crea un entorno virtual para evitar conflictos de versiones:

````bash
python3 -m venv caldera-env
````
Luego, activa el entorno virtual:

````bash
source caldera-env/bin/activate
````
![f72](/assets/imagen/f72.png)

![f73](/assets/imagen/f73.png)

## Paso 2: Instalar Caldera
Con el entorno virtual activado, instala Caldera usando pip:
````bash
pip install caldera
````
## Paso 3: Instalar el plugin EMU
Para instalar el plugin EMU, primero necesitas clonar el repositorio de GitHub:
````bash
git clone https://github.com/mitre/emu.git 
cd emu 
pip install -r requirements.txt
````
Luego, añade el plugin EMU a la configuración de Caldera:

````bash
echo "- emu" >> caldera/conf/local.yml
````
![f75](/assets/imagen/f75.png)

## Paso 4: Iniciar Caldera con el plugin EMU
Finalmente, inicia Caldera:

````bash
caldera
````
El plugin EMU debería aparecer en el panel lateral de Caldera, y podrás acceder a los perfiles de emulación adversaria desde la pestaña de Adversar

## Actualización del Kali y preliminares

Actualizar Repositorios y Hacer Upgrade
Es una buena práctica mantener tu sistema Kali Linux actualizado para tener las últimas versiones de paquetes y parches de seguridad. Para ello, puedes usar los siguientes comandos en la terminal:

```bash
┌──(user㉿kali)-[~]
└─$ sudo apt update && sudo apt upgrade -y
```
*sudo apt update: Actualiza la lista de paquetes disponibles desde los repositorios configurados.*
*sudo apt upgrade -y: Actualiza los paquetes instalados a sus versiones más recientes disponibles.*

Estos comandos garantizan que tu sistema esté al día con las últimas actualizaciones.

## Crear una Carpeta Caldera

Para organizar mejor los archivos relacionados con Caldera, puedes crear una carpeta específica. Utiliza el siguiente comando en la terminal:

```bash
┌──(user㉿kali)-[~]
└─$ mkdir ~/Caldera
```
*mkdir ~/Caldera:* Crea una carpeta llamada Caldera en tu directorio principal (~).*

Esto es útil para mantener todos los archivos y configuraciones de Caldera en un solo lugar, facilitando la gestión y el acceso.

## Crear un Entorno Virtual de Python

Primero, cambiamos al directorio Caldera que creamos anteriormente:

```bash
┌──(user㉿kali)-[~]
└─$ cd ~/Caldera
└─$ python -m venv caldera-env
```
Para activar el entorno virtual, ejecutamos:
```bash
┌──(user㉿kali)-[~/Caldera]
└─$ source caldera-env/bin/activat   
┌──(caldera-env)─(user㉿kali)-[~/Caldera]
```

Al activar el entorno virtual, verás que el prompt de tu terminal cambia para indicar que estás dentro del entorno caldera-env:

```bash
┌──(caldera-env)─(user㉿kali)-[~/Caldera]
```

Una vez que el entorno virtual esté activo, puedes proceder a instalar Caldera y sus dependencias sin afectar otros proyectos de Python en tu sistema. Esto es crucial para mantener un desarrollo organizado y evitar problemas de compatibilidad.

## Ingresamos con admin:admin

![f77](/assets/imagen/f77.png)

## Dashboard de Caldera
El dashboard de Caldera proporciona una interfaz gráfica de usuario (GUI) donde puedes gestionar y monitorear tus operaciones de emulación de amenazas. Aquí tienes una descripción general de las secciones principales que podrías encontrar en el dashboard:

*Panel de Control (Dashboard): Muestra una vista general de las operaciones activas, el estado de los agentes, y los últimos eventos o alertas*.
*Operaciones (Operations): Aquí puedes ver una lista de todas las operaciones de emulación de amenazas, con detalles sobre cada una, como el nombre de la operación, el estado actual, y la fecha de inicio y fin.*
*Agentes (Agents): Esta sección muestra una lista de todos los agentes desplegados en la red, incluyendo información sobre su estado, versión y el sistema en el que están instalados.*
*Plugins:Caldera permite la integración de diversos plugins para extender su funcionalidad. En esta sección puedes ver y gestionar los plugins instalados.*
*Tareas (Tasks):Aquí puedes ver las tareas individuales que se están ejecutando como parte de las operaciones, incluyendo detalles sobre el progreso y los resultados.*
*Reportes (Reports):Genera y visualiza reportes detallados sobre las operaciones de emulación de amenazas, con información sobre las vulnerabilidades encontradas y las recomendaciones de mitigación.*

![f78](/assets/imagen/f78.png)

## Verificar el Plugin EMU
En la lista de plugins, busca el plugin EMU. Debería mostrar información sobre su estado actual, como "Enabled" o "Active". Si el plugin está correctamente cargado, deberías ver algún indicador visual de que está activo.

![f79](/assets/imagen/f79.png)

